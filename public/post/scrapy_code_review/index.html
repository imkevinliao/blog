<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
><head>
  <title>
    Kevin
   
  </title>

 

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.68.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta
    name="description"
    content="
      Less is More


    "
  />
  
  
  
  <link
    rel="stylesheet"
    href="/css/main.min.747c2051c988c578be617a76ccc39f8ccfbe01837a9c2dffa1816ceee36333fa.css"
    integrity="sha256-dHwgUcmIxXi&#43;YXp2zMOfjM&#43;&#43;AYN6nC3/oYFs7uNjM/o="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.cc84ed683057cc175ddfa738ea6ba2d5c882b95cb64f50bf9be918cb3791887b.css"
    integrity="sha256-zITtaDBXzBdd36c46mui1ciCuVy2T1C/m&#43;kYyzeRiHs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
    crossorigin="anonymous"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="/post/scrapy_code_review/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.413f798d8aa82610bef17a5ca1d7e962ec185be395f1aeb3f45d1891af568b65.js"
    integrity="sha256-QT95jYqoJhC&#43;8XpcodfpYuwYW&#43;OV8a6z9F0Yka9Wi2U="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.fcf9526f15b3b4e08472de192969ab28a4cdcb32ac94f83e85a8b84e9b45acd2.js"
      integrity="sha256-/PlSbxWztOCEct4ZKWmrKKTNyzKslPg&#43;hai4TptFrNI="
      crossorigin="anonymous"
    ></script>

  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://example.com/images/site-feature-image.png"/>

<meta name="twitter:title" content="Scrapy"/>
<meta name="twitter:description" content="Scrapy创建项目:"/>



  


  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "Scrapy",
        "headline": "Scrapy",
        "alternativeHeadline": "",
        "description": "
      
        Scrapy创建项目:


      


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/example.com\/post\/scrapy_code_review\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Kevin"
        },
        "creator" : {
            "@type": "Person",
            "name": "Kevin"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Kevin"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Kevin"
        },
        "copyrightYear" : "2020",
        "dateCreated": "2020-12-19T21:30:26.00Z",
        "datePublished": "2020-12-19T21:30:26.00Z",
        "dateModified": "2020-12-19T21:30:26.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Kevin",
            "url": "https://example.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/example.com\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "https://example.com/images/site-feature-image.png"


      
      ]

    ,
        "url" : "https:\/\/example.com\/post\/scrapy_code_review\/",
        "wordCount" : "279",
        "genre" : [ ],
        "keywords" : [ ]
    }
  </script>



</head>
<body>
    <header><div
  class="page-top 
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
  </a>
  <nav>
    <ul class="nav__list" id="navMenu">
      <div class="nav__links">
        
        
          
          <li>
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/post/"
              
              title=""
              >Posts</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>

        
          
          <li>
            <a
              
              href="/connect/"
              
              title=""
              >Connect</a
            >
          </li>

        
        
      </div>
      <li>
        
          <a class="theme-switch" title="Switch Theme">
            <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
          </a>

        
      </li>
    </ul>
  </nav>
</div>
</header>
    <div class="wrapper">
      <aside><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="logo-title">
      <div class="title">
        <img src="/images/profile.jpg" alt="profile picture" />
        <h3 title=""><a href="/">imkevinliao</a></h3>
        <div class="description">
          <p>Less is More</p>
        </div>
      </div>
    </div>
    <ul class="social-links">
      
        <li>
          <a href="https://github.com/imkevinliao/imkevinliao.github.io" rel="me" aria-label="GitHub">
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="mailto:im.kevinliao@gmail.com" rel="me" aria-label="e-mail">
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer--sidebar">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2020-2022

        
      </li>
      
        <li class="footer__item">
          <a
            href="/imprint/"
            
            title=""
          >
            imprint
          </a>
        </li>

      
    </ul>
  </div>

</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js"
    integrity="sha256-vceyOv9jSXp5Qzs5ILA&#43;JHM5nZCtTC2Hz3wI0z1hlm8="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main>
        <div class="autopagerize_page_element">
          <div class="content">
  <div
    class="post 
      animated fadeInDown

    "
  >
    <div class="post-content">
      
      <div class="post-title">
        <h1>Scrapy</h1>
        
          <div class="info">
            <em class="fas fa-calendar-day"></em>
            <span class="date"
              >
                2020/12/19


              </span
            >
            <em class="fas fa-stopwatch"></em>
            <span class="reading-time">2-minute read</span>
          </div>

        
      </div><p>Scrapy创建项目:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">    scrapy startproject ScrpyDirection
    cd ScrapyDirection
    scrapy genspider -t crawl myspider www.baidu.com #创建全站爬虫,这种创建方式下myspider.py文件中已近包含items.py直接用就好了
    scrapy genspider myspider www.baidu.com #创建 一般/普通 爬虫
</code></pre></div><p>Scrapy快速启动:(创建start.py文件)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">    os.system(&#39;cls&#39;) # 终端清屏
    os.chdir( r&#34;D:\SpiderDirection&#34;)
    os.system(&#34;scrapy crawl YourSpiderName&#34;)
    os.system(&#34;scrapy crawl YourSpiderName -s JOBDIR=Remain/001&#34;) # 提高改进
</code></pre></div><p>Scrapy数据抽取写法:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">    //*[@class=&#34;title&#34;]//text() 提取class=title标签下的所有文本
    ./div[id=&#34;mainn&#34;]  即xpath提取了一个xpath路径，然后继续往下提取文本，拼接xpath时使用，一般没必要.
    //a/@href 提取所有a标签的href属性
    item[&#39;domain_id&#39;] = response.xpath(&#39;//input[@id=&#34;sid&#34;]/@value&#39;).get()
    item[&#39;name&#39;] = response.xpath(&#39;//div[@id=&#34;name&#34;]&#39;).get()
    item[&#39;description&#39;] = response.xpath(&#39;//div[@id=&#34;description&#34;]&#39;).get()
    contain=&#39;&#39;.join(contain).strip() #list变成str
    response.content.decode(&#39;utf-8&#39;);response.encoding;(一个是手动解码,一个是自动解码)
    dic1={&#34;name&#34;:&#34;youran&#34;,&#34;num&#34;:&#34;170423&#34;};dict2=dict(name=&#34;youran&#34;,num=&#34;170423&#34;).字典的两种创建方式.
</code></pre></div><p>数据持久化部分:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">    with open(&#34;allowed_domains.txt&#34;, &#39;a+&#39;,encoding=&#39;utf-8&#39;) as f:
        f.write(m_str)  
    r = requests.get(url)
    with open(&#34;file.zip&#34;,&#34;wb&#34;) as f:
        f.write(r.content)

    #jsonVersion1.0
    from scrapy.exporters import JsonLinesItemExporter
    class QidianPipeline(object):
        def __init__(self):
            self.fp=open(&#39;qidian.json&#39;,&#39;wb&#39;)
            self.exporter=JsonLinesItemExporter(self.fp,ensure_ascii=False,encoding=&#39;utf-8&#39;)
        def process_item(self, item, spider):
            self.exporter.export_item(item)
            return item  #这里要注意最好是return item，因为如果pipelines中写了几个，必须返回给其他pipeline使用
        def close_spider(self,spider):
            self.fp.close()

    #jsonVersion2.0(官方示例写法)
    import json
    class QidianPipeline(object):
        def __init__(self):
            self.fp=open(&#39;qidian.json&#39;,&#39;w&#39;,encoding=&#39;utf-8&#39;)
        def process_item(self, item, spider):
            line = json.dumps(item,ensure_ascii=False) + &#34;\n&#34;
            self.fp.write(line)
            return item
        def close_spider(self,spider):
            self.fp.close()  

    #保存为txt
    class TextPipeline(object):
        def __init__(self):
            pass
        def process_item(self, item, spider):
            with open(&#34;a.txt&#34;,&#34;a&#34;,encoding=&#34;utf-8&#34;) as f:
                title=item[&#39;title&#39;]
                contain=item[&#39;contain&#39;]
                f.write(title+&#39;\n&#39;+contain+&#39;\n&#39;)
            return item
</code></pre></div><p>About items.py: 这部分可以自己写,items本质就是字典,写个字典将数据传给pipeline处理也是一样的.<br>
举例：name = scrapy.Field()</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">About settings.py 
    ROBOTSTXT_OBEY = False #不遵守爬虫协议，改False，默认True
    # 默认注释, 取消之, 并增加user-agent:
    DEFAULT_REQUEST_HEADERS = {
    &#39;Accept&#39;: &#39;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#39;,
    &#39;Accept-Language&#39;: &#39;en&#39;,
    &#39;User-Agent&#39;:&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36&#39;,
    }

    ITEM_PIPELINES = {
    &#39;qidian.pipelines.TextPipeline&#39;: 300,#开启这一项，yield item 数据才会进入pipelines，需要pipeline处理数据就开启，
    &#39;qidian.pipelines.JsonPipeline&#39;: 400,#数字越小越先执行,如果这里开了多个pipelines，那么pipelines文件中必须也含有这些所有的
    }
    DOWNLOAD_DELAY = 2 #下载延时, 支持浮点数据.
    DOWNLOAD_TIMEOUT = 15  # 下载超时
    RETRY_ENABLED = True # 尝试次数
    RETRY_TIMES = 3
    DEPTH_LIMIT= 3 # 设置爬取深度
</code></pre></div><p>进阶部分:
为了避免爬取过程异常退出而导致重新爬取采取如下措施:项目目录下要有Remain文件夹.命令:scrapy crawl  &lt;爬虫名&gt;  -s JOBDIR=Remain/001;继续运行:scrapy crawl &lt;爬虫名&gt;  -s JOBDIR=remain/001 .备注:需要重新爬取就换个文件如002就行了.&lt;os.system(&ldquo;scrapy crawl myspider -s JOBDIR=Remain/001&rdquo;)&gt;.<br>
Scrapy爬虫以项目目录为基准目录.即scrapy startproject ScrpyDirection,所以相对路径也是基于该目录.<br>
allowed_domains = [&lsquo;www.baidu.com&rsquo;] #允许域影响yield则注释掉,这个对全站爬虫Rules部分有影响,建议注释掉.<br>
yield scrapy.Request(next_url,callback=self.parse,dont_filter=True)#普通爬虫才用这个把下个爬取链接给调度器,dont_filter=True如果缺少将不会跟进爬取，就是只爬一次，不继续往下爬.<br>
yield item #item必须是字典<br>
pipelines这个组件数据持久化貌似是数据全部爬取完毕再一次性写入,这个问题很大.应该一边爬取一边写入才合理.<br>
item=QidianItem(book_name=book_name,book_intro=book_intro).使用items.py.<br>
start_urls:全站爬虫可以指定多个初始url.</p>
<p>其他代码:</p>
<p>如果不存在该文件夹则创建</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">import os 
main_path=&#34;./Image&#34; 
if  not os.path.exists(main_path):
    os.makedirs(main_path)
</code></pre></div><p>全站爬虫rules部分解析</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">rules = (
        Rule(LinkExtractor(allow=&#34;&lt;正则表达式,当然,还可以写deny(禁止)的规则&gt;&#34;),follow=True),
        Rule(LinkExtractor(allow=&#34;.+book\.qidian\.com/info/\d*&#34;), callback=&#39;parse_detail&#39;, follow=False),
        #follow=True是指如果页面含有符合allow正则的链接就继续提取到调度器
        #callback=parse_item,系统默认的.警告:parse_item这个方法不能复写,这是因为scrapy框架决定,建议注释掉或删掉(最好放着别管).
    )
</code></pre></div><p>利用PIL库下载图片,更漂亮的写法.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"> def down_image_b(self,url):
        import requests
        from PIL import Image
        from io import BytesIO
        main_path=&#34;./image&#34;
        if  not os.path.exists(main_path):
            os.makedirs(main_path)
        response = requests.get(url)
        image = Image.open(BytesIO(response.content))
        image.save(&#39;./image/f.jpg&#39;)
</code></pre></div></div>
    <div class="post-footer">
      <div class="info">
        

        
      </div>
    </div>

    
  </div>


          </div>
        </div>
      </main>
    </div><footer class="footer footer--base">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2020-2022

        
      </li>
      
        <li class="footer__item">
          <a
            href="/imprint/"
            
            title=""
          >
            imprint
          </a>
        </li>

      
    </ul>
  </div>

</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js"
    integrity="sha256-vceyOv9jSXp5Qzs5ILA&#43;JHM5nZCtTC2Hz3wI0z1hlm8="
    crossorigin="anonymous"
  ></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.0/dist/APlayer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.0/dist/APlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    <meting-js fixed="true" auto="https://music.163.com/#/song?id=1494835439"></meting-js>
    
  </body>
</html>
